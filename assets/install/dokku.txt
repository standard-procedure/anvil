# After cloudinit, the following needs to be run to install dokku:
# Add this in as `anvil dokku install /path/to/config`
# and make it read the plugins from the config file

# SSH into your server and paste the script
sudo bash
echo "dokku dokku/vhost_enable boolean true" | sudo debconf-set-selections
wget https://dokku.com/install/v0.30.7/bootstrap.sh && sudo DOKKU_TAG=v0.30.7 bash bootstrap.sh
cat /home/app/.ssh/authorized_keys | dokku ssh-keys:add admin
dokku plugin:install https://github.com/dokku/dokku-cron-restart.git cron-restart
dokku plugin:install https://github.com/dokku/dokku-maintenance.git maintenance
dokku plugin:install https://github.com/dokku/dokku-redis.git redis
dokku plugin:install https://github.com/dokku/dokku-memcached.git memcached
dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git letsencrypt
dokku config:set --global DOKKU_LETSENCRYPT_EMAIL=sysadmin@echodek.co
dokku git:set --global deploy-branch main
exit

# Then use `anvil app install` to set up the dokku app on the server
# SWITCH ALL CHECKS OFF
#Â Need to add the following to the app install setup

dokku resource:limit --memory 2048m app
dokku checks:disable app worker
dokku checks:disable app web
# Also change the nginx options so it's just load_balancer: true/false use that to figure out whether to install let's encrypt or not

# Next up `anvil app deploy` which will check if a remote exists for each host, if not it will add them.
# Then it pushes the current branch to main for each host.
# Once complete it runs the post deploy scripts and scales the app (set these per host?)
dokku ps:scale app web=2 worker=1
# and installs the let's encrypt certificate and cron-job if required
# Finally it switches checks back on
dokku checks:disable app web

# Other commands: anvil app update which updates the configuration and scaling for the app



